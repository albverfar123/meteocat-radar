<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Visor Acumulats Radar + Estacions</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body { height: 100%; margin: 0; overflow: hidden; font-family: -apple-system, system-ui, sans-serif; }
        .header {
            position: absolute; top: 0; left: 0; right: 0; height: 60px;
            background: #1a1a1a; color: white; display: flex; align-items: center;
            justify-content: space-between; padding: 0 16px; z-index: 2000; box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .header-tabs button {
            background: transparent; border: none; color: #aaa; padding: 6px 12px;
            cursor: pointer; font-weight: bold; font-size: 12px; border-radius: 6px;
        }
        .header-tabs button.active { background: #007bff; color: white; }
        #map { position: absolute; top: 60px; bottom: 0; width: 100%; background: #f0f0f0; }
        .control {
            position: absolute; background: white; z-index: 1500; padding: 15px;
            display: flex; flex-direction: column; gap: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        /* Estil per a les etiquetes de les estacions */
        .station-label {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0,0,0,0.2);
            border-radius: 3px;
            text-align: center;
            font-size: 10px;
            font-weight: bold;
            color: #333;
            pointer-events: none !important;
        }
        @media (min-width: 601px) { .control { top: 80px; right: 20px; width: 260px; border-radius: 12px; } }
        @media (max-width: 600px) { .control { bottom: 0; width: 100%; border-radius: 20px 20px 0 0; box-sizing: border-box; } }
        .legend-box { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .colorbar { height:12px; width:100%; background: linear-gradient(to right, #00008F, #0000FF, #007FFF, #00FFFF, #7FFF7F, #FFFF00, #FF7F00, #FF0000, #7F0000); }
    </style>
</head>
<body>

<div class="header">
    <div id="titleHeader" style="font-weight:bold">Radar + Estacions</div>
    <div class="header-tabs">
        <button id="modeDaily" class="active">DIARI</button>
        <button id="modeWeekly">SETMANAL</button>
    </div>
</div>

<div id="map"></div>

<div class="control" id="mainControl">
    <div id="weekRangeDisplay" style="font-size:11px; color:#007bff; font-weight:bold; text-align:center; display:none;">--</div>
    <input id="datePicker" type="date" style="width:100%; padding:8px; margin-bottom:5px;">
    
    <div style="display:flex; gap:5px; margin-bottom:10px;">
        <button id="prevBtn" style="flex:1">◀</button>
        <button id="nextBtn" style="flex:1">▶</button>
    </div>

    <div id="statusMsg" style="font-size:12px; text-align:center; margin-bottom:5px;">Iniciant...</div>

    <label style="font-size:12px; display:flex; align-items:center; gap:5px;">
        <input type="checkbox" id="checkStations" checked> Veure dades estacions (mm)
    </label>
    <label style="font-size:12px; display:flex; align-items:center; gap:5px;">
        <input type="checkbox" id="checkCatalunya"> Mapa Catalunya (PNG)
    </label>
    
    <input id="opacitySlider" type="range" min="0" max="1" step="0.1" value="0.8">
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
var map = L.map('map', { zoomControl: false }).setView([41.7, 1.8], 7);
L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png').addTo(map);

var overlayRadar = null;
var stationsLayer = L.layerGroup().addTo(map);
var viewMode = 'daily';
var radarBounds = null; // Variable global per als límits

// Funció per calcular dates
function getDates(dateIn) {
    let d = new Date(dateIn);
    const fmt = (date) => date.toISOString().slice(0,10).replace(/-/g, "");
    
    // Setmana Natural (Dl-Dg)
    let day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1);
    let monday = new Date(d.setDate(diff));
    let sunday = new Date(monday); sunday.setDate(monday.getDate() + 6);

    // Setmana de Prova (Acaba en el dia triat)
    let endTrial = new Date(dateIn);
    let startTrial = new Date(dateIn); startTrial.setDate(startTrial.getDate() - 6);

    return {
        daily: fmt(new Date(dateIn)),
        weeklyStart: fmt(monday),
        weeklyEnd: fmt(sunday),
        trialStart: fmt(startTrial),
        trialEnd: fmt(endTrial)
    };
}

// Carregar els límits una sola vegada des de bounds.json
async function initMap() {
    try {
        const response = await fetch('bounds.json');
        const b = await response.json();
        radarBounds = [[b.lat_min, b.lon_min], [b.lat_max, b.lon_max]];
        console.log("Límits carregats:", radarBounds);
    } catch (e) {
        console.error("Error carregant bounds.json, usant valors fallback", e);
        radarBounds = [[40.0, 0.0], [43.5, 3.8]]; 
    }
    updateView(); 
}

async function updateView() {
    if (!radarBounds) return; // Esperar a que initMap hagi carregat els límits

    const dates = getDates(document.getElementById("datePicker").value);
    const status = document.getElementById("statusMsg");
    const weekDisplay = document.getElementById("weekRangeDisplay");
    
    if (overlayRadar) map.removeLayer(overlayRadar);
    stationsLayer.clearLayers();

    if (viewMode === 'daily') {
        weekDisplay.style.display = "none";
        loadRadar(`acumulats_diaris/acumulat_${dates.daily}.png`);
    } else {
        weekDisplay.style.display = "block";
        weekDisplay.textContent = `Setmana fins al ${dates.trialEnd.slice(6,8)}/${dates.trialEnd.slice(4,6)}`;
        
        let pathNatural = `acumulats_setmanals/setmanal_${dates.weeklyStart}_${dates.weeklyEnd}.png`;
        let pathTrial = `acumulats_setmanals/setmanal_${dates.trialStart}_${dates.trialEnd}.png`;
        
        loadRadar(pathNatural, async (success) => {
            if (!success) {
                loadRadar(pathTrial);
                loadStations(dates.trialStart, dates.trialEnd);
            } else {
                loadStations(dates.weeklyStart, dates.weeklyEnd);
            }
        });
    }
}

async function loadRadar(path, callback) {
    const img = new Image();
    img.onload = () => {
        overlayRadar = L.imageOverlay(path, radarBounds, { 
            opacity: document.getElementById("opacitySlider").value 
        }).addTo(map);
        document.getElementById("statusMsg").textContent = "✔ Carregat";
        if(callback) callback(true);
    };
    img.onerror = () => {
        document.getElementById("statusMsg").textContent = "✖ Arxiu no trobat";
        if(callback) callback(false);
    };
    img.src = path;
}

async function loadStations(start, end) {
    if (!document.getElementById("checkStations").checked) return;
    try {
        const res = await fetch(`acumulats_setmanals/estacions_${start}_${end}.json`);
        const data = await res.json();
        L.geoJSON(data, {
            pointToLayer: (feature, latlng) => {
                return L.marker(latlng, {
                    icon: L.divIcon({
                        className: 'station-label',
                        html: feature.properties.pluja,
                        iconSize: [25, 15]
                    })
                }).bindTooltip(`${feature.properties.nom}: ${feature.properties.pluja} mm`);
            }
        }).addTo(stationsLayer);
    } catch (e) { console.log("JSON no trobat"); }
}

// Botons de Mode
document.getElementById("modeDaily").onclick = function() { viewMode='daily'; this.classList.add('active'); document.getElementById("modeWeekly").classList.remove('active'); updateView(); };
document.getElementById("modeWeekly").onclick = function() { viewMode='weekly'; this.classList.add('active'); document.getElementById("modeDaily").classList.remove('active'); updateView(); };

// Controls
document.getElementById("datePicker").onchange = updateView;
document.getElementById("checkStations").onchange = updateView;
document.getElementById("prevBtn").onclick = () => { let d = new Date(datePicker.value); d.setDate(d.getDate()-1); datePicker.value=d.toISOString().slice(0,10); updateView(); };
document.getElementById("nextBtn").onclick = () => { let d = new Date(datePicker.value); d.setDate(d.getDate()+1); datePicker.value=d.toISOString().slice(0,10); updateView(); };

// Inici des de initMap per carregar coordenades primer
let d = new Date(); d.setDate(d.getDate()-1);
document.getElementById("datePicker").value = d.toISOString().slice(0,10);
initMap();
</script>
</body>
</html>
